<html ng-app="app">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta name="format-detection" content="telephone=no"/>
    <meta name="msapplication-tap-highlight" content="no"/>
    <title>房卡包</title>
    <link rel="stylesheet" type="text/css" href="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/css2/activity.css">
    <link rel="stylesheet" type="text/css" href="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/css2/package_detail.css">
    <script src="https://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
    <script type="text/javascript" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/js/jquery-1.9.1.min.js"></script>
    <script type="text/javascript" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/js/angular.min.js"></script>
    <script type="text/javascript" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/js/fastclick.js"></script>
    <script type="text/javascript" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/js/clipboard.min.js"></script>
    <script type="text/javascript" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/js/fuzhi_xl.js?v=201180291723"></script>
    <script type="text/javascript">
        document.write('<script type="text/javascript" src="./js/config.js?v='+ new Date().getTime() +'"> <\/script>');
        document.write('<script type="text/javascript" src="./js/load.js?v='+ new Date().getTime() +'"> <\/script>');
    	//var vConsole = new VConsole();
    	//var vConsole = new window.VConsole();
    </script>
</head>

<body ng-controller="myCtrl" style="background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/package/package_bg.jpg);background-size: 100% 100%;">
<div style="position: fixed;width:100%;height:100%;top:0;left:0;background: #000" id="loading">
    <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/loading.gif"
         style="top: 40%;position: absolute;left: 50%;margin-left: -45px;margin-top: -45px;"/>
</div>
<div class="main" style="display: none;">

    <div id="dialog" style="display:none">
        <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/common/cancel.png" onclick="fuzhiMain.closeDialog()">
        <p id="main" class="main">
        </p>
        <p class="other">
            请手动复制
        </p>
    </div>
    <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/common/back2.png" class="backToHall" ng-click="backToHall()">
    <span class="copy-tip" id="tips" style="display:none">已复制到剪贴板</span>
    <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/hall/hall-copy.png" class="needsclick zhuonuo copyUrl"
         data-clipboard-action="copy" id="copy_btn" onclick="fuzhiMain.link()"/>
    <textarea id="room_str" readonly="readonly"></textarea>

    <!--<img src="files/images/redpackage/redpackage_bg.jpg" style="width: 100%;position: relative;" usemap="#planetmap" />-->

    <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/redpackage/fly.png" style="width: 100%;margin-top:15%" usemap="#planetmap"/>

    <div id="notopen" style="position: fixed;height: 100vh;width: 100vw;top: 0;left: 0;">

        <div class="user"
             style="position: absolute;width: 17.5vw;height: 17.5vw;left: 50%;top: 3vh;transform: translateX(-50%);background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/avatar_box.png);background-size: 100% 100%;">
            <img ng-src="{{redPackage.sendAvatar}}" class="avatar"
                 style="position: absolute;width: 16vw;top: 0.5vw;height: 16vw;left: 50%;transform: translateX(-50%);"/>
        </div>

        <p style="position: absolute; color: #fedf00; width: 90%; left: 5%; top: 14vh; height: auto; text-align: center; font-size: 17pt; word-wrap: break-word; word-break: break-all;">
            <span style="color: #fff;">{{redPackage.sendName}}</span>
            <br/>
            给你发了一个房卡包
        </p>

        <div ng-click="clickOpenRedPackage()">
            <img class="light" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/package/light.png"/>
            <img class="btnOpen" src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/package/package_box.png"/>
        </div>

        <div style=" position: absolute; left: 22px; right: 22px; top: {{height - 160}}px;">
            <p style="text-align: center; color: #fff; font-size: 11pt"></p>
        </div>
    </div>

    <div id="ropen" style="position: fixed;height: 100vh;width: 100vw;top: 0;left: 0; display: none;">
        <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/package/package_bg2.jpg" style="width: 100%;height:50vh"/>

        <div class="user"
             style="position: absolute;width: 17.5vw;height: 17.5vw;left: 50%;top: 6vh;transform: translateX(-50%);background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/avatar_box.png);background-size: 100% 100%;">
            <img ng-src="{{redPackage.sendAvatar}}" class="avatar"
                 style="position: absolute;width: 16vw;top: 0.5vw;height: 16vw;left: 50%;transform: translateX(-50%);"/>
        </div>

        <p style="position: absolute; color: #fff; width: 90%; left: 5%; top: 17vh; text-align: center; font-size: 16pt;">来自 {{redPackage.sendName}} 的房卡红包</p>

        <p style="position: absolute; color: #fdcb00; width: 90%; left: 5%; top: 28vh; text-align: center; font-size: 44pt;">{{redPackage.count}} <span style="font-size: 16pt;">张</span></p>

        <p style="position: absolute; color: #fff; width: 90%; left: 5%; top: 40vh; text-align: center; font-size: 18pt;">可用于创建房间</p>

        <p style="position: fixed; width: 100vw; height: 50vh;top: 50vh; left: 0;font-size: 11pt; color: black; text-align: left; background: #fff;">
            <div class="user"
                 style="position: absolute;width: 15.5vw;height: 15.5vw;left: 6vw;top: 56vh;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/avatar_box.png);background-size: 100% 100%;">
                <img ng-src="{{redPackage.receiveAvatar}}" class="avatar" style="position: absolute;width: 14vw;top: 0.5vw;height: 14vw;left: 50%;transform: translateX(-50%);"/>
            </div>
            <br/>
            <span style="color: lightgray;position:absolute; right: 6vw;top: 62vh;">{{redPackage.showTime}}</span>
        </p>

        <div style="position:absolute; left: 0vw;top: 52vh;font-size: 20px;width: 100vw;">
            <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/package/line.jpg" style="position: absolute;top: 2vh;left: 0; width: 34vw;">
            <span style="position: absolute;left: 50%;transform: translateX(-50%);color: #958888;font-size: 18px;">红包领取记录</span>
            <img src="http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/package/line.jpg" style="position: absolute;top: 2vh;right: 0; width: 34vw;" >
        </div>

        <span style="position:absolute; left: 24vw;top: 56vh;font-size: 20px;width: 70vw;overflow: hidden;white-space: nowrap;text-overflow: ellipsis;">{{redPackage.receiveName}}</span>

        <p style="position:absolute; left: 24vw;top: 61vh;">领取了 <span style="color: red;font-size: 16px;">{{redPackage.count}}张</span>房卡</p>
    </div>

    <!-- 绑定手机号码 -->
    <div id="validePhone" style="position: relative;z-index: 102;" ng-show="isAuthPhone==1">
        <div class="phoneMask"
             style="position: fixed;z-index: 98;top: 0;left: 0;width: 100%;height: 100%;background-color: rgba(0,0,0,0.5);"
             ng-click="hideBindPhone()"></div>
        <div class="phoneFrame"
             style="position: fixed;z-index: 99;width: 98vw; height: 70vh;top: 50%; left: 50%;transform:translate(-50%,-50%);color: white;overflow: initial;">
            <div style="height: 2.2vw;"></div>
            <div style="font-size: 5.5vw;height: 11vh; text-align: center;line-height: 13vh; word-wrap: break-word;word-break: break-all;color: #fff;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/code_box_top.png);background-size: 100% 100%;">
                {{phone!=''?'修改手机':'为了您的房卡安全，请绑定手机'}}
            </div>
            <div style="background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/code_box_center.png);background-size: 100% 100%;">
                <div style="padding: 0 4vw;font-size: 5vw; word-wrap: break-word;word-break: break-all;color: #000;" ng-if="phone==''">
                    绑定手机号和设置密码后。可以在QQ、支付宝或浏览器上登录开房玩游戏。从此妈妈再也不用担心我玩不了游戏了
                </div>
                <div style="height: 2.2vw;"></div>
                <div style="position: relative;height: 15vw;word-wrap: break-word;word-break: break-all;color: #000;border-top: solid;border-color: #e6e6e6;border-width: 0px;">
                    <input ng-change="phoneChange()" ng-model="sPhone" type="number" name="phone" ng-blur="blur()" placeholder="请输入手机号码" style="padding:0 12px 0 12px;position: absolute;left: 5vw;width: 88vw;height: 13vw;line-height: 6.5vw;border-style: solid;border-width: 1px;border-radius: 1vh;border-color: #fff;font-size: 4vw;-webkit-appearance: none;">
                </div>
                <div style="height: 4vw;line-height: 4vw;font-size: 3.5vw;text-align: left;margin-left: 10vw;">
                    {{updatePhone.phoneError}}
                </div>
                <div style="position: relative;height: 13vw;word-wrap: break-word;word-break: break-all;color: #000;border-top: solid;border-color: #e6e6e6;border-width: 0px;">
                    <input ng-model="sAuthcode" type="number" name="phone1" placeholder="输入4位数字验证码" ng-blur="blur()" style="padding:0 12px 0 12px;position: absolute;left: 5vw;width: 58vw;height: 13vw;line-height: 6.5vw;border-style: solid;border-width: 1px;border-radius: 1vh;border-color: #fff;font-size: 4vw;-webkit-appearance: none;">
                    <div ng-if="authcodeTime==0" id="authcode" ng-click="getAuthcode()" style="position: absolute;right: 5vw; width: 27vw;height: 13vw;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/btn_get_code.png);background-size: 100% 100%;"></div>
                    <div ng-if="authcodeTime>0" id="authcode" style="position: absolute;right: 5vw; width: 27vw;height: 13vw;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/btn_get_code.png);background-size: 100% 100%;border-radius: 10px;">
                        <div style="width: 27vw;height: 13vw;line-height: 13vw;font-size: 18px;background: rgba(0,0,0,0.5);    text-align: center;color: #fff;border-radius: 10px;">{{authcodeTime}}</div>
                    </div>
                </div>
                <div style="height: 4vw;line-height: 4vw;color: red;font-size: 3.5vw;text-align: left;margin-left: 10vw;">
                    {{updatePhone.authcodeError}}
                </div>
            </div>
            <div style="position: relative; height: 16vh; font-size: 4vw;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/code_box_bottom.png);background-size: 100% 100%;">
                <div  style="position: absolute; height: 8vh;line-height: 8vh;text-align: center;width: 28vw;top: 50%;transform: translateY(-40%);left: 12vw; font-size: 6vw;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/btn1.png);background-size: 100% 100%;" ng-click="hideBindPhone()">下次验证</div>
                <div  style="position: absolute; height: 8vh;line-height: 8vh;text-align: center;width: 28vw;top: 50%;transform: translateY(-40%);right: 12vw; font-size: 6vw;background: url(http://dyxdy8.oss-cn-hangzhou.aliyuncs.com/files/images2/daoyou/page/btn2.png);background-size: 100% 100%;" ng-click="bindPhone(sPhone)">确定</div>
            </div>
        </div>
    </div>

    <div class="alert" ng-show="isShowAlert">
        <div class="alertBack"></div>
        <div class="mainPart">
            <div class="backImg">
                <div class="blackImg"></div>
            </div>
            <div class="alertText">{{alertText}}</div>
            <div ng-show="alertType==1">
                <div class="buttonMiddle" ng-click="closeAlert()">确定</div>
            </div>
            <div ng-show="alertType==3">
                <div class="buttonLeft" ng-click="gotoHall()">返回首页</div>
                <div class="buttonRight" ng-click="closeAlert()">取消</div>
            </div>
            <div ng-show="alertType==6">
                <div class="buttonMiddle" ng-click="closeAlert()">确定</div>
            </div>
            <div ng-show="alertType==23">
                <div class="buttonMiddle" ng-click="finishBindPhone()">确定</div>
            </div>

        </div>
    </div>

</div>
<script type="text/javascript">


    var red_code = DynLoading.getUrlParam("red_code");
    var obj = DynLoading.hall(BaseUrl + '/ay1/rpD?red_code=' + red_code);

    if(obj.result != 0){
        alert(obj.result_message);
        var return_url = window.location.href;
        console.log(return_url);
        window.location.href = '/index.html?return_url=' + return_url + '&t=' + obj.data.t;
    }
    console.log(obj);

    var globalData = {
        "baseUrl": BaseUrl + "/",
        "hallPath":"/index.html",
        "isWechat": obj.data.is_weixin,
        "isXianliao": obj.data.is_xianliao,
        "shareTitle": obj.data.platfrom_name + ":门票包",
        "xlTitle":"门票包",
        //"isAuthPhone": obj.data.isAuthPhone,
        "isAuthPhone": 0,
        "phone": obj.data.phone,
		"hallName": obj.data.platfrom_name,
    };

    var userData = {
        "accountId": obj.data.account_id,
        "nickname": obj.data.user.nickname,
        "avatar": obj.data.user.headimgurl,
        "card": obj.data.card
    };

    globalData.wid = obj.data.wid;
    globalData.tt = obj.data.tt;
	
	// 修改浏览器title
	var new_userName = "";
	var old_userNname = obj.data.user.nickname;
	if (old_userNname.length > 8) {
	    new_userName = old_userNname.substring(0, 7);
	    new_userName += "..."
	}
	else {
	    new_userName = old_userNname;
	}
	document.getElementsByTagName("title")[0].innerText = new_userName + "|" + globalData.hallName;

    var app = angular.module('app', [])

    app.directive('ngInput', [function () {
        return {
            restrict: 'A',
            require: '?ngModel',
            link: function (scope, element, attrs) {
                element.on('input', oninput);
                scope.$on('$destroy', function () {//销毁的时候取消事件监听
                    element.off('input', oninput);
                });

                function oninput(event) {
                    scope.$evalAsync(attrs['ngInput'], {$event: event, $value: this.value});
                }
            }
        }
    }]);

    app.controller("myCtrl", function ($scope, $http) {
        $scope.width = window.innerWidth;
        $scope.height = window.innerHeight;
        $scope.rpHeight = $scope.width * 1.02;
        $scope.rpWidth = $scope.width * 0.76
        $scope.rpLeft = $scope.width * 0.12;
        $scope.rpX = $scope.rpWidth * 0.08;
        $scope.rpTop = ($scope.height - $scope.rpHeight) / 2 - 30;
        $scope.lineTop = $scope.rpTop + $scope.rpHeight / 2;
        $scope.receiveNameX = $scope.rpX * 1.5 + $scope.width * 0.1;
        $scope.receiveNameWidth = ($scope.rpWidth - $scope.rpX * 3 - $scope.width * 0.1) / 1.5;
        $scope.receiveNameOffset = 2;
        $scope.receiveCountWidth = $scope.rpWidth - $scope.receiveNameX - $scope.receiveNameWidth - $scope.receiveNameOffset - $scope.rpX * 0.7;

        $scope.userInfo = {
            "accountId": obj.data.account_id,
            "nickname": obj.data.user.nickname,
            "avatar": obj.data.user.headimgurl,
            "card":0,
        }

        $scope.redPackage = {
            "isReceive": obj.data.red_package.is_receive,
            "content": obj.data.red_package.content,
            "count": obj.data.red_package.ticket_count,
            "sendName": obj.data.red_package.nickname,
            "sendAvatar": obj.data.red_package.headimgurl,
            "receiveName": obj.data.red_package.receive_nickname,
            "receiveAvatar": obj.data.red_package.receive_headimgurl,
            "receiveTime": obj.data.red_package.receive_time,
            "showTime":"",
            "code": red_code,
        }

        if ($scope.redPackage.isReceive == 0) {
            $scope.redPackage.receiveAvatar = $scope.userInfo.avatar;
            $scope.redPackage.receiveName = $scope.userInfo.name;
        }

        $scope.userInfo.card = 0;

        var socketStatus = 0;
        $(".main").show();
        $("#loading").hide();

        $scope.blockBtn = false;
        $scope.activity = new Array();
        $scope.isShowAlert = false;
        $scope.alertType = 0;
        $scope.alertText = "";
        $scope.gotoHall = function () {
            //alert('你点击了我的');
            window.location.href = "/";
        }
        $scope.showAlert = function (type, text) {
            $(".alertText").css("top", "90px")
            $scope.alertType = type;
            $scope.alertText = text;
            $scope.isShowAlert = true;

            setTimeout(function () {
                $scope.$apply();
            }, 0);

            setTimeout(function () {
                var wHeight = window.innerHeight;
                var alertHeight = $(".alertText").height();
                var textHeight = $(".alertText").height();

                if (alertHeight < wHeight * 0.15) {
                    alertHeight = wHeight * 0.15;
                }

                if (alertHeight > wHeight * 0.8) {
                    alertHeight = wHeight * 0.8;
                }

                var mainHeight = alertHeight + wHeight * (0.022 + 0.034) * 2 + wHeight * 0.022 + wHeight * 0.056;
                if (type == 8) {
                    mainHeight = mainHeight - wHeight * 0.022 - wHeight * 0.056
                }

                var blackHeight = alertHeight + wHeight * 0.034 * 2;
                var alertTop = wHeight * 0.022 + (blackHeight - textHeight) / 2;

                $(".alert .mainPart").css('height', mainHeight + 'px');
                $(".alert .mainPart").css('margin-top', '-' + mainHeight / 2 + 'px');
                $(".alert .mainPart .backImg .blackImg").css('height', blackHeight + 'px');
                $(".alert .mainPart .alertText").css('top', alertTop + 'px');

                $scope.$apply();
            }, 0)
        }
        $scope.closeAlert = function () {
            if ($scope.alertType == 1) {
                $scope.isShowAlert = false;
                if (!$scope.is_connect) {
                    $scope.is_connect = true;
                }
            } else {
                $scope.isShowAlert = false;
            }
        }
        $scope.backToHall = function () {
            var url = globalData.hallPath + '?' + new Date().getTime();
            window.location.replace(url)
        }


        $scope.cardNum = Number($scope.userInfo.card);
        $scope.number = 0; //输入数量
        $scope.inputNumber = null;  //输入框数字

        if ($scope.cardNum === null
            || $scope.cardNum === undefined
            || isNaN($scope.cardNum)) {
            $scope.cardNum = 0;
        }

        setTimeout(function () {
            if ($scope.redPackage.isReceive == 1) {
                $("#notopen").hide();
                $("#ropen").show();
            } else {
                $("#notopen").show();
                $("#ropen").hide();
            }

        }, 1);
        $scope.formatShowTime = function () {

            var newDate = new Date($scope.redPackage.receiveTime);
            newDate.setTime($scope.redPackage.receiveTime * 1000);
            var Month = (newDate.getMonth() + 1 < 10 ? '0' + (newDate.getMonth() + 1) : newDate.getMonth() + 1);
            var Day = newDate.getDate() + ' ';
            var Day = newDate.getDate() < 10 ? '0' + newDate.getDate() : newDate.getDate();
            var hour = newDate.getHours() < 10 ? '0' + newDate.getHours() : newDate.getHours();
            var min = newDate.getMinutes() < 10 ? '0' + newDate.getMinutes() : newDate.getMinutes();

            $scope.redPackage.showTime = Month + '-' + Day + '    ' + hour + ':' + min;
        }
        $scope.formatShowTime();
        $scope.receiveRedPackage = function () {

            $http({
                url: globalData.baseUrl + 'ay1/receiveRP',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    "Authorization": DynLoading.getWwid()
                },
                withCredentials: true,//必须要填
                data: {
                        'account_id': userData.accountId,
                        'code': $scope.redPackage.code,
                    }
                })
                .success(function (data, header, config, status) {

                    var timestamp = Date.parse(new Date());
                    timestamp = timestamp / 1000;
                    $scope.redPackage.receiveTime = timestamp;
                    $scope.formatShowTime();

                    setTimeout(function () {

                        if (data.result == 0) {
                            $("#ropen").show();
                            $("#notopen").hide();
                        }else if(data.result == 2){
                            $scope.isAuthPhone = 1;
                            $scope.$apply();
                        } else {
                            window.location.reload();
                            //alert(data.result_message);
                        }
                    }, 500);
                    setTimeout(function () {
                        $scope.blockBtn = false
                    }, 2000)
                })
                .error(function (data, header, config, status) {
                    $(".btnOpen").removeClass('transf');
                    // window.location.reload();
                    setTimeout(function () {
                        $scope.blockBtn = false
                    }, 2000)
                    alert(data.result_message);
                });
        }
        setTimeout(function () {
            var tempDiv = document.getElementById('openImg');
            if (tempDiv) {
                tempDiv.addEventListener('touchstart', function (event) {
                    $('#openImg').animate({top: "-10%", left: "-10%", width: "120%", height: "120%"}, 30);
                }, false);

                tempDiv.addEventListener('touchend', function (event) {
                    $('#openImg').animate({top: "0%", left: "0%", width: "100%", height: "100%"}, 30);
                }, false);
            }
        }, 100);
        $scope.clickOpenRedPackage = function () {

            if ($scope.blockBtn == true) {

                return;
            }

            $scope.blockBtn = true;
            $('#openImg').animate({top:"-10%",left:"-10%",width:"120%",height:"120%"},30);
            $scope.receiveRedPackage();
            setTimeout(function () {
                $('#openImg').animate({top:"0%",left:"0%",width:"100%",height:"100%"},30);
            }, 0);
        }

        /* 绑定手机 */
        $scope.isAuthPhone = globalData.isAuthPhone;
        $scope.phone = globalData.phone;
        $scope.sPhone = '';
        $scope.sAuthcode = '';
        $scope.authcodeType = 1;
        $scope.authcodeText = '发送验证码';
        $scope.authcodeTime = 0;
        $scope.phoneType = 1;
        $scope.phoneText = '绑定手机';
        $scope.updatePhone = {
            phoneError: '',
            authcodeError: ''
        };

        setTimeout(function () {
            $scope.$apply();
        }, 100);

        $scope.hideBindPhone = function () {
            //$('#validePhone').css('display', 'none');
            $scope.isAuthPhone = 0;
        };
        $scope.getAuthcodeHttp = function (phone) {

            $http({
                url: globalData.baseUrl +  'account/getMobileSms',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    "Authorization": DynLoading.getWwid()
                },
                withCredentials: true,//必须要填
                data: {
                    "phone": phone,
                    "session": "",
                },
            }).success(function (data) {

                if (data.result == 0) {
                    setTimeout(function () {
                        $scope.authcodeTime = 60;
                        authcodeTimer();
                        $scope.authcodeType = 1;
                    }, 0);

                } else {
                    alert(data.result_message)
                }
            }).error(function (data) {
                console.log(data);
            });
        };
        $scope.bindPhoneHttp = function (phone, authcode) {
            $http({
                url: globalData.baseUrl + 'account/checkSmsCode',
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    "Authorization": DynLoading.getWwid()
                },
                withCredentials: true,//必须要填
                data: {
                    "phone": phone,
                    "code": authcode,
                    "session": "",
                },
            }).success(function (data) {

                if (data.result == 0) {
                    setTimeout(function () {
                        $scope.isAuthPhone = 0;
                        $scope.phone = $scope.sPhone;

                        if (data.data.account_id != $scope.userInfo.id) {
                            $scope.showAlert(23, data.result_message);
                        } else {
                            $scope.showAlert(6, data.result_message);
                        }

                        $scope.userInfo.card = parseInt($scope.userInfo.card) + parseInt(data.data.card_count);

                        $scope.sPhone = '';
                        $scope.sAuthcode = '';
                        $scope.$apply();
                    }, 0);
                } else {
                    setTimeout(function () {
                        $scope.showAlert(6, data.result_message);
                        $scope.$apply();
                    }, 0);
                }
            }).error(function (data) {
                setTimeout(function () {
                    $scope.authcodeTime = 0;
                    $scope.showAlert(6, "绑定失败");
                    $scope.$apply();
                }, 0);
            });
        };
        $scope.finishBindPhone = function () {
            window.location.href = window.location.href + "&id=" + 10000 * Math.random() + "&wid=123";
        };
        $scope.reloadView = function () {
            window.location.href = window.location.href + "&id=" + 10000 * Math.random() + "&wid=123";
        };
        $scope.bindPhone = function () {
            var validPhone = checkPhone($scope.sPhone);
            var validAuthcode = checkAuthcode($scope.sAuthcode);

            if (validPhone == false) {
                setTimeout(function () {
                    $scope.showAlert(6, '手机号码有误，请重填');
                    $scope.$apply();
                }, 0);

                return;
            }

            if (validAuthcode == false) {
                setTimeout(function () {
                    $scope.showAlert(6, '验证码有误，请重填');
                    $scope.$apply();
                }, 0);

                return;
            }

            $scope.bindPhoneHttp($scope.sPhone, $scope.sAuthcode);
        };
        $scope.getAuthcode = function () {

            if ($scope.authcodeType != 1) {
                return;
            }

            var color = $('#authcode').css('background-color');


            if (color != 'rgb(64, 112, 251)') {
                //return;
            }

            var validPhone = checkPhone($scope.sPhone);

            if (validPhone == false) {

                setTimeout(function () {
                    $scope.showAlert(6, '手机号码有误，请重填');
                    //$scope.$apply();
                }, 10);

                return;
            }

            $scope.getAuthcodeHttp($scope.sPhone);
        };
        $scope.phoneChange = function () {
            var result = checkPhone($scope.sPhone);
            if (result) {
                $('#authcode').css('background-color', 'rgb(64,112,251)');
            } else {
                $('#authcode').css('background-color', 'lightgray');
            }
        };

        function checkPhone(phone) {

            if (!(/^1(3|4|5|7|8)\d{9}$/.test(phone))) {
                return false;
            } else {
                return true;
            }
        };
        function checkAuthcode(code) {
            if (code == '' || code == undefined) {
                return false;
            }

            var reg = new RegExp("^[0-9]*$");
            if (!reg.test(code)) {
                return false;
            } else {
                return true;
            }
        };
        var authcodeTimer = function authcodeTimer() {
            if ($scope.authcodeTime <= 0) {
                $scope.authcodeText = '发送验证码';
                $scope.authcodeTime = 60;
                $scope.authcodeType = 1;
                return;
            }

            $scope.authcodeTime = $scope.authcodeTime - 1;
            $scope.authcodeText = $scope.authcodeTime + 's';

            setTimeout(function () {
                $scope.$apply();
            }, 0);

            setTimeout(function () {
                authcodeTimer();
            }, 1000);
        };
    })

    $(function () {
        wx.config({
            debug: false,
             appId: "",
            timestamp: "",
            nonceStr:"",
            signature: "",
            jsApiList: [
                'onMenuShareTimeline',
                'onMenuShareAppMessage',
                'hideMenuItems',
            ]
        });

        wx.ready(function () {
            wx.hideMenuItems({
                menuList: [
                    "menuItem:copyUrl",
                    "menuItem:share:qq",
                    "menuItem:share:weiboApp",
                    "menuItem:share:facebook",
                    "menuItem:share:QZone",
                    "menuItem:editTag",
                    "menuItem:copyUrl",
                    "menuItem:share:email",
                ] // 要隐藏的菜单项，只能隐藏“传播类”和“保护类”按钮，所有menu项见附录3
            });

            wx.onMenuShareTimeline({
                title: "房卡包",
                desc: "给你发了一个房卡包",
                link: "",
                imgUrl: "",
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });

            wx.onMenuShareAppMessage({
                title: "房卡包",
                desc: "给你发了一个房卡包",
                link: "",
                imgUrl: "",
                success: function () {
                    // 用户确认分享后执行的回调函数
                },
                cancel: function () {
                    // 用户取消分享后执行的回调函数
                }
            });
        });
    });
</script>
<script type="text/javascript">
    document.addEventListener('WeixinJSBridgeReady', function onBridgeReady() {
        // 通过下面这个API隐藏右上角按钮
        WeixinJSBridge.call('hideOptionMenu');
    });
</script>
</body>
</html>